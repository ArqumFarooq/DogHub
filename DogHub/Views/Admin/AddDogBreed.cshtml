@{
    ViewBag.Title = "Add Dog Breed";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<img id="loadImg" src='../Content/assets/images/loading.gif' width='100' style="position:fixed; margin-top:20%; margin-left:35%; z-index:111; display:none" />

<div class="row" style="min-height:700px;">
    <br />
    <br />
    <form action="@Url.Action("PostAddDogBreed", "Admin")" method="post" enctype="multipart/form-data">
        <div class="row m-10">
            <div class="col-md-6 col-md-offset-3">
                <div class="panel panel-flat">
                    <div class="panel-heading">
                        <div class="text-left" style="color: @ViewBag.Color" id="alertMsg">
                            @ViewBag.Message
                        </div>
                        <h4 class="panel-title text-center"><b><u>Create New Dog Breed</u></b></h4>
                    </div>
                    <div class="panel-body">

                        <div class="form-group has-feedback">
                            <label class="text-bold">Breed Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" placeholder="Enter Breed Name" name="DogName" id="DogName" required>
                            <div class="form-control-feedback">
                                <i class="icon-dog text-muted"></i>
                            </div>
                        </div>

                        <div class="form-group has-feedback">
                            <label class="text-bold">Parent Breed <span class="text-danger"></span></label>
                            <select name="ParentBreedId" id="ParentBreedId" class="form-control">
                                <option value="">-- Select Parent Breed (optional)--</option>
                                @if (ViewBag.ParentBreeds != null)
                                {
                                    foreach (var item in ViewBag.ParentBreeds)
                                    {
                                        <option value="@item.PK_DogBreedId">@item.DogName</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="form-group has-feedback">
                            <label class="text-bold">Origin Country<span class="text-danger">*</span></label>
                            <select name="Origin" id="Origin" class="form-control">
                                <option value="">-- Select Country --</option>
                                @if (ViewBag.Countries != null)
                                {
                                    foreach (var country in ViewBag.Countries)
                                    {
                                        <option value="@country">@country</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="form-group has-feedback">
                            <label class="text-bold">Life Span (in years)<span class="text-danger">*</span></label>
                            <input type="number" step="0.1" class="form-control" name="LifeSpan" id="LifeSpan" min="0.1" placeholder="e.g., 12.5">
                        </div>

                        <div class="form-group has-feedback">
                            <label class="text-bold">Description <span class="text-danger">*</span></label>
                            <textarea class="form-control" placeholder="Enter Description or Fetch from AI" name="Description" id="Description" required></textarea>
                            <div class="form-control-feedback">
                                <i class="icon-dog text-muted"></i>
                            </div>
                        </div>

                        <div class="form-group has-feedback">
                            <label class="text-bold">Upload a Dog Image or Fetch from AI</label>
                            <input type="file" class="form-control" id="dogImageInput" name="ImageFile" accept="image/*" />

                            <div id="previewContainer" style="margin-top: 10px; display: none;">
                                <img id="imagePreview" src="#" alt="Image Preview" style="max-width: 200px; border: 1px solid #ddd; padding: 5px; border-radius: 5px;" />
                                <p id="imageMessage" style="color: red; display: none;"></p>
                                <br />
                                <button type="button" id="removeImageBtn" class="btn btn-sm btn-danger mt-2">Remove</button>
                            </div>
                        </div>

                        <input type="hidden" name="DogImageUrl" id="DogImageUrl" />

                        <div class="text-right">
                            <button type="button" id="generateFromAI" class="btn bg-orange-800 legitRipple">Generate Description</button>
                            <button type="button" id="getImage" class="btn bg-teal legitRipple">Get Dog Image</button>
                            <button type="submit" class="btn btn-primary" id="sub">Create <i class="icon-checkmark3 position-right"></i></button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>

    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("dogImageInput");

        input.addEventListener("change", function () {
            const file = this.files[0];
            const validTypes = ["image/jpeg", "image/png", "image/gif", "image/webp"];

            try {
                if (!validTypes.includes(file.type)) {
                    alert("Only image files (jpg, png, gif, webp) are allowed.");
                    this.value = "";
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    alert("File size should not exceed 10MB.");
                    this.value = "";
                    return;
                }

                // No preview — file is accepted silently
                console.log("Valid image selected:", file.name);

            } catch (err) {
                console.error("File upload error:", err);
                alert("Something went wrong while validating the file.");
                this.value = "";
            }
        });
    });

    //document.addEventListener("DOMContentLoaded", function () {
    //    const input = document.getElementById("dogImageInput");
    //    const previewContainer = document.getElementById("previewContainer");
    //    const preview = document.getElementById("imagePreview");
    //    const removeBtn = document.getElementById("removeImageBtn");

    //    input.addEventListener("change", function () {
    //        const file = this.files[0];
    //        if (!file) return;

    //        // Validate file type
    //        const validTypes = ["image/jpeg", "image/png", "image/gif", "image/webp"];
    //        if (!validTypes.includes(file.type)) {
    //            alert("Only image files (jpg, png, gif, webp) are allowed.");
    //            this.value = "";
    //            previewContainer.style.display = "none";
    //            return;
    //        }

    //        // Validate size (2MB max)
    //        if (file.size > 10 * 1024 * 1024) {
    //            alert("File size should not exceed 2MB.");
    //            this.value = "";
    //            previewContainer.style.display = "none";
    //            return;
    //        }

    //        const reader = new FileReader();
    //        reader.onload = function (e) {
    //            preview.src = e.target.result;
    //            previewContainer.style.display = "block";
    //        };
    //        reader.readAsDataURL(file);
    //    });

    //    removeBtn.addEventListener("click", function () {
    //        input.value = "";
    //        preview.src = "#";
    //        previewContainer.style.display = "none";
    //    });
    //});

    $('#generateFromAI').click(function () {
        $('#loadImg').show();

        var dogName = $('#DogName').val().trim();
        var parentBreedId = $('#ParentBreedId option:selected').text().trim();
        var parentBreedVal = $('#ParentBreedId').val();
        var parentBreed = (parentBreedVal === "0" || parentBreedId === "-- Select Parent Breed (optional)") ? null : parentBreedId;
        var origin = $('#Origin option:selected').val().trim();
        var lifeSpan = $('#LifeSpan').val().trim();

        // Check which fields are empty
        var missingFields = [];

        if (dogName === "") missingFields.push("Dog Name");
        if (origin === "") missingFields.push("Origin");
        if (lifeSpan === "") missingFields.push("Life Span");

        if (missingFields.length > 0) {
            var message = "Oops! Please fill in the following before generating AI description: " + missingFields.join(", ") + ".";

            $('#alertMsg').html(message).css("color", "red").fadeIn();
            setTimeout(function () {
                $('#alertMsg').fadeOut();
            }, 4000);

            $('#loadImg').hide();
            return;
        }


        $('#alertMsg').html("");

        $.ajax({
            type: "POST",
            url: '../Admin/GenerateBreedDescription',
            dataType: "json",
            data: {
                DogName: dogName,
                ParentBreed: parentBreed,
                Origin: origin,
                LifeSpan: lifeSpan
            },
            success: function (response) {
                $('#Description').val(response.description);
                $('#loadImg').hide();
            },
            error: function () {
                $('#loadImg').hide();
                alert('Failed to generate description.');
            }
        });
    });
    
    $('#getImage').click(function () {

        $('#loadImg').show();
        $('#previewContainer').show();
        var breed = $('#DogName').val().toLowerCase().trim();
        if (!breed) {
            $('#imageMessage').text("Please enter a breed name.").show();
            $('#imagePreview').hide();
            $('#loadImg').hide();
            return;
        }

        $('#imageMessage').hide();
        $('#imagePreview').hide();

        const apiUrl = `https://dog.ceo/api/breed/${breed}/images/random`;

        $.ajax({
            type: "GET",
            url: apiUrl,
            success: function (response) {
                if (response.status === "success") {
                    $('#imagePreview').attr('src', response.message).show();
                    $('#DogImageUrl').val(response.message); 
                } else {
                    $('#imageMessage').text("No image found for this dog breed.").show();
                    $('#previewContainer').hide();
                    $('#DogImageUrl').val('');
                }
                $('#loadImg').hide();
            },
            error: function () {
                $('#imageMessage').text("No image found for this dog breed.").show();
                $('#previewContainer').hide();
                $('#DogImageUrl').val('');
                $('#loadImg').hide();
            }
        });
    });

</script>
